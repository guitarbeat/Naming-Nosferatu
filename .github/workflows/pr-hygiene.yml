name: PR Hygiene

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Comment missing PR sections
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            const requiredSections = [
              "## Summary",
              "## Validation",
              "## Rollout + Revert Plan"
            ];
            const missing = requiredSections.filter((s) => !body.includes(s));
            if (missing.length === 0) return;

            const marker = "<!-- pr-hygiene-bot -->";
            const note = `${marker}\nMissing required PR template sections:\n- ${missing.join("\n- ")}\n\nPlease fill them in to speed review and safe deployment.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            const existing = comments.find((c) => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: note,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: note,
              });
            }
